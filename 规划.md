

## 1. 坐标转换：描述“我在哪”的语言

WBC 需要处理大量坐标系（世界系、机体系、足端系、相机系）。

* **旋转的表达**：
* **欧拉角 (Euler Angles)**：直观但有“万向节死锁（Singularity）”。
* **四元数 (Quaternions)**：WBC 程序中最常用的姿态表达，必须搞懂单位四元数的性质。
* **旋转矩阵 ()**：一切旋转计算的本质。


* **齐次变换矩阵 ()**：把旋转和平移打包在一起的  矩阵。
* **伴随变换 (Adjoint Map)**：**（重点）** 如何把一个坐标系下的速度/力转换到另一个坐标系。例如：把足端的力矩转换到机身中心。

## 2. 运动学 (Kinematics)：描述“怎么动”的几何

* **正运动学 (FK)**：已知关节角 ，求足端在空间的位置。
* **逆运动学 (IK)**：已知目标位置，求关节角。
* *WBC 视角*：WBC 通常不解位置级 IK，而是解**速度级 IK**（利用雅可比矩阵）。


* **浮基模型 (Floating Base)**：**（核心）** 四足机器人不像机械臂是固定在地面上的。它的第一个“关节”是机身相对于世界的 6 自由度变换。

## 3. 雅可比矩阵 (Jacobian)：机器人学的“万能钥匙”

它是连接“关节空间”和“笛卡尔空间”的桥梁，也是你代码里出现频率最高的东西。

* **几何雅可比 (Geometric Jacobian)**：。它描述了关节速度如何映射到足端速度。
* **雅可比的转置**：。**（极其重要）** 这是静力学的基础，描述了足端受到的地面反作用力如何转化为电机的力矩。
* **雅可比求导 ()**：在计算加速度级 WBC 时，你需要知道雅可比随时间的变化。

## 4. 静力学 (Statics)：力的平衡艺术

在梅花桩任务中，静力学决定了机器人能否站稳。

* **力与力矩的平衡**：。
* **虚拟功原理**：这是推导  的物理本质。
* **支撑多面体与稳定性**：理解什么是 **CoP (压力中心)** 和 **GRF (地面反作用力)**。

## 5. 动力学 (Dynamics)：物理世界的灵魂

这是 WBC 能够实现“高动态”运动的原因。

* **动力学方程的标准型**：


* ：质量矩阵（惯性）。
* ：科氏力与离心力（动起来之后的干扰力）。
* ：重力项。


* **质心动力学 (Centroidal Dynamics)**：把整个机器人看作一个质点，研究动量和动量矩的变化。这是 MPC 和 WBC 握手的关键。

---

## 🛠 学习建议清单（按重要程度排序）

| 知识点         | 为什么要学                                     | 推荐练习                                        |
| -------------- | ---------------------------------------------- | ----------------------------------------------- |
| **坐标系变换** | 保证你的坐标修正（ICP/Fast-LIO）不把方向搞反。 | 手写一个  矩阵乘法，变换一个点坐标。            |
| **雅可比转置** | 让 J60 电机输出正确的力来撑起身体。            | 给定足端受力，手动推算 3 个关节电机的力矩。     |
| **浮基动力学** | 让机器人意识到自己是“飘”在空中的。             | 在 **Pinocchio** 中提取  矩阵，看它维数对不对。 |
| **摩擦锥约束** | 保证机器人在梅花桩上不“打滑”。                 | 画出摩擦力  与法向力  的关系图。                |

---

## 📅 从零开始的 7 天 WBC 仿真进阶计划

### 第 1 天：动力学底座与 Pinocchio 集成

**目标：** 在仿真中实时获取机器人的“物理属性”。

* **核心内容：**
* 集成 **Pinocchio** 库，加载 URDF，确保仿真中的 `rbdState` 能正确映射到模型。
* **计算质量矩阵 **：这是机器人的惯性分布。
* **计算非线性项 **：包括科里奥利力和重力项。
* **获取足端雅可比 **：用于将足端力转化为关节力矩。



### 第 2 天：QP 优化问题的数学建模

**目标：** 写出 WBC 的“数学灵魂”——二次规划方程。

* **核心内容：**
* **定义决策变量**：通常为 ，其中  是 18 维广义加速度， 是 12 维足端力。
* **建立动力学约束**：。
* **建立摩擦锥约束**：确保 ，防止在仿真地面上“劈叉”。
* **选择求解器**：集成 `OSQP` 或 `eiquadprog`。



### 第 3 天：静态站立与全重力补偿

**目标：** 机器人能在 Gazebo 中平稳站立，且关节表现出“柔顺性”。

* **核心内容：**
* **设置任务 1：高度与姿态保持**。将期望加速度设为 0，仅靠 WBC 抵消重力。
* **验证力矩映射**：。
* **仿真测试**：在 Gazebo 中用鼠标“拽”一下机器人，看它是否能像弹簧一样晃动并回到原位（验证重力补偿是否扣得干净）。



### 第 4 天：接入 LKF 状态估计闭环

**目标：** 利用你做好的卡尔曼滤波数据，实现动态平衡。

* **核心内容：**
* **引入反馈**：将 LKF 输出的机体速度和高度作为 WBC 的初值。
* **计算 PD 任务加速度**：。
* **调参**：调整 。如果 LKF 数据有延迟，你会发现机器人在仿真里开始剧烈“抽搐”，这时需要优化你的加速度低通滤波。



### 第 5 天：摆动腿轨迹与任务优先级定义

**目标：** 在机体不倒的前提下，优雅地抬起一只脚。

* **核心内容：**
* **定义任务优先级（Null-space projection）**：
1. **高优先级**：接触约束（脚不能入地）与机体平衡。
2. **次高优先级**：摆动腿足端轨迹追踪。


* **实现轨迹函数**：编写摆动腿的摆线轨迹。
* **仿真测试**：在仿真中循环执行“站立-单腿划圈-站立”。



### 第 6 天：接触力平滑切换逻辑

**目标：** 解决“抬腿瞬间机体剧烈晃动”的问题。

* **核心内容：**
* **实现 Contact Smoothing**：当一只脚准备抬起时，在 QP 约束中将其支撑力的上限  在 50ms 内平滑降至 0。
* **权重动态调整**：根据步态时序（Gait Table），动态切换 QP 中各条腿的惩罚权重。



### 第 7 天：慢速行走（Crawl Gait）全链路跑通

**目标：** 机器人在 Gazebo 中实现平稳的 0.1m/s 行走。

* **核心内容：**
* **步态整合**：将步态时序、摆动腿轨迹与 WBC 平衡逻辑完全串联。
* **速度闭环**：通过修改期望轨迹的位移，观察 LKF 反馈的真实速度是否能跟上指令。
* **录制波形**：检查在行走过程中，WBC 计算出的关节力矩是否平滑，是否有超过 J60 电机物理极限的异常跳变。



---

## 🛠 WBC 的详细计算框架（QP 形式）

为了方便你在代码中实现，WBC 的标准优化目标函数通常定义为：

**受限于：**

1. **动力学方程**：
2. **接触约束**：（支撑腿不准动）
3. **摩擦锥**：
4. **力矩极限**：

---
